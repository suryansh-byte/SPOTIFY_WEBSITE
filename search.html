<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify ‚Äì Search</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Simple styles for search results */
    .results { margin-top: 16px; display: grid; gap: 12px; }
    .result-item { display:flex; gap:12px; align-items:center; padding:8px; background:rgba(255,255,255,0.03); border-radius:6px; }
    .result-item img { width:64px; height:64px; border-radius:6px; object-fit:cover; }
    .result-meta { flex:1; min-width:0; }
    .result-title { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .result-sub { color:#b3b3b3; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .result-actions { display:flex; gap:8px; }
    .search-empty { color:#b3b3b3; margin-top:12px; }
  </style>
</head>
<body>
  <div class="spotify-app">
    <!-- Sidebar -->
      <aside class="sidebar">
      <div class="logo">
        <img src="https://upload.wikimedia.org/wikipedia/commons/2/26/Spotify_logo_with_text.svg" alt="Spotify" class="logo-img" />
      </div>

      <nav class="nav-main">
        <a href="index.html">
          <span class="nav-icon">üè†</span>
          <span>Home</span>
        </a>
        <a href="search.html" class="active">
          <span class="nav-icon">üîç</span>
          <span>Search</span>
        </a>
        <a href="#">
          <span class="nav-icon">üìö</span>
          <span>Your Library</span>
        </a>
      </nav>

      <nav class="nav-secondary">
        <a href="#">
          <span class="nav-icon">Ôºã</span>
          <span>Create Playlist</span>
        </a>
        <a href="#">
          <span class="nav-icon">‚ù§</span>
          <span>Liked Songs</span>
        </a>
      </nav>
    </aside>

    <!-- Main area -->
    <div class="main-area">
      <!-- Top bar -->
      <header class="topbar">
        <div class="arrows">
          <button>&lt;</button>
          <button>&gt;</button>
        </div>
        <button class="user-btn">User</button>
      </header>

      <!-- Search page content -->
      <main class="content">
        <!-- Search input -->
        <section class="section">
          <h2>Search</h2>
          <p style="color:#b3b3b3; margin-bottom:12px;">
            What do you want to listen to?
          </p>
          <div class="search-bar-wrapper">
            <span class="search-icon">üîç</span>
            <input
              id="searchInput"
              type="text"
              class="search-input"
              placeholder="Search for songs, artists, albums, or podcasts"
              autocomplete="off"
            />
            <button id="spotifyLoginBtn" style="margin-left:8px;">Login with Spotify</button>
            <span id="spotifyStatus" style="color:#b3b3b3; margin-left:8px; font-size:0.9rem;"></span>
          </div>
          <div id="results" class="results" aria-live="polite"></div>
          <div id="empty" class="search-empty" style="display:none;">No results</div>
          
        </section>

        <!-- Browse all style grid -->
        <section class="section">
          <div class="section-header">
            <h2>Browse all</h2>
          </div>

          <div class="search-grid">
            <div class="search-card sc-music">Music</div>
            <div class="search-card sc-podcasts">Podcasts</div>
            <div class="search-card sc-audiobooks">Audiobooks</div>
            <div class="search-card sc-made">Made for You</div>
            <div class="search-card sc-charts">Charts</div>
            <div class="search-card sc-new">New Releases</div>
            <div class="search-card sc-discover">Discover</div>
            <div class="search-card sc-live">Live Events</div>
            <div class="search-card sc-moods">Mood</div>
            <div class="search-card sc-workout">Workout</div>
            <div class="search-card sc-party">Party</div>
            <div class="search-card sc-chill">Chill</div>
          </div>
        </section>
      </main>

      <!-- Player (same as home page) -->
      <footer class="player">
        <div class="player-left">
          <img id="playerCover" src="" alt="cover" class="player-cover" />
          <div class="player-meta">
            <span id="playerTitle" class="player-title">Song title</span>
            <span id="playerArtist" class="player-artist">Artist name</span>
          </div>
        </div>

        <div class="player-center">
          <div class="player-controls">
            <button id="prevBtn">‚èÆ</button>
            <button id="playBtn" class="play-btn">‚ñ∂</button>
            <button id="nextBtn">‚è≠</button>
          </div>
          <div class="player-progress">
            <span id="currentTime" class="time">0:00</span>
            <div id="progress" class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
              <div id="barFill" class="bar-fill"></div>
            </div>
            <span id="durationTime" class="time">0:00</span>
          </div>
        </div>

        <div class="player-right">
          <button id="muteBtn">üîä</button>
          <div id="volBar" class="vol-bar">
            <div id="volFill" class="vol-fill" style="width:70%"></div>
          </div>
        </div>
      </footer>

  <script>
    (function(){
      // Simple player manager
      const player = (function(){
        const cover = document.getElementById('playerCover');
        const title = document.getElementById('playerTitle');
        const artist = document.getElementById('playerArtist');
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('durationTime');
        const progress = document.getElementById('progress');
        const barFill = document.getElementById('barFill');
        const volBar = document.getElementById('volBar');
        const volFill = document.getElementById('volFill');
        const muteBtn = document.getElementById('muteBtn');

        let audio = new Audio();
        audio.crossOrigin = 'anonymous';
        let playlist = [];
        let index = -1;

        function formatTime(s){
          if (!isFinite(s)) return '0:00';
          const m = Math.floor(s/60); const sec = Math.floor(s%60).toString().padStart(2,'0');
          return `${m}:${sec}`;
        }

        audio.addEventListener('timeupdate', ()=>{
          currentTimeEl.textContent = formatTime(audio.currentTime);
          const pct = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
          barFill.style.width = pct + '%';
        });

        audio.addEventListener('durationchange', ()=>{
          durationEl.textContent = formatTime(audio.duration);
        });

        audio.addEventListener('ended', ()=>{
          // auto-next
          playNext();
        });

        playBtn.addEventListener('click', ()=>{
          if (audio.paused) audio.play(); else audio.pause();
          updatePlayButton();
        });

        audio.addEventListener('play', updatePlayButton);
        audio.addEventListener('pause', updatePlayButton);

        function updatePlayButton(){
          playBtn.textContent = audio.paused ? '‚ñ∂' : '‚è∏';
        }

        progress.addEventListener('click', (e)=>{
          const rect = progress.getBoundingClientRect();
          const pct = (e.clientX - rect.left)/rect.width;
          if (audio.duration) audio.currentTime = pct * audio.duration;
        });

        volBar.addEventListener('click', (e)=>{
          const rect = volBar.getBoundingClientRect();
          const pct = Math.min(1, Math.max(0, (e.clientX - rect.left)/rect.width));
          audio.volume = pct;
          volFill.style.width = (pct*100) + '%';
        });

        muteBtn.addEventListener('click', ()=>{
          audio.muted = !audio.muted;
          muteBtn.textContent = audio.muted ? 'üîà' : 'üîä';
        });

        prevBtn.addEventListener('click', ()=>{ playPrev(); });
        nextBtn.addEventListener('click', ()=>{ playNext(); });

        function playPrev(){
          if (playlist.length === 0) return;
          index = (index - 1 + playlist.length) % playlist.length;
          loadAndPlay(index);
        }

        function playNext(){
          if (playlist.length === 0) return;
          index = (index + 1) % playlist.length;
          loadAndPlay(index);
        }

        function loadAndPlay(i){
          const item = playlist[i];
          if (!item) return;
          audio.src = item.previewUrl;
          cover.src = item.artworkUrl100 || '';
          title.textContent = item.trackName || '';
          artist.textContent = item.artistName || '';
          audio.play();
          updatePlayButton();
        }

        function playTrack(track){
          // insert at next position and play
          playlist.unshift(track);
          index = 0;
          loadAndPlay(index);
        }

        return { playTrack };
      })();

      // Search UI -> use player
      const input = document.getElementById('searchInput');
      const results = document.getElementById('results');
      const empty = document.getElementById('empty');
      let debounceTimer = null;

      input.addEventListener('input', () => {
        const q = input.value.trim();
        clearTimeout(debounceTimer);
        if (!q) {
          results.innerHTML = '';
          empty.style.display = 'none';
          return;
        }
        debounceTimer = setTimeout(() => search(q), 300);
      });

      async function search(q) {
        results.innerHTML = '<div class="search-empty">Searching‚Ä¶</div>';
        empty.style.display = 'none';
        try {
          const url = `https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=25`;
          const res = await fetch(url);
          const data = await res.json();
          if (!data.results || data.results.length === 0) {
            results.innerHTML = '';
            empty.style.display = 'block';
            return;
          }
          empty.style.display = 'none';
          results.innerHTML = data.results.map(r => {
            const track = {
              previewUrl: r.previewUrl || '',
              artworkUrl100: r.artworkUrl100 || '',
              trackName: r.trackName || '',
              artistName: r.artistName || '',
              collectionName: r.collectionName || '',
              trackViewUrl: r.trackViewUrl || ''
            };
            return `
              <div class="result-item" data-preview="${escapeHtml(track.previewUrl)}" data-artwork="${escapeHtml(track.artworkUrl100)}" data-track="${escapeHtml(track.trackName)}" data-artist="${escapeHtml(track.artistName)}" data-url="${escapeHtml(track.trackViewUrl)}">
                <img src="${track.artworkUrl100}" alt="artwork">
                <div class="result-meta">
                  <div class="result-title">${escapeHtml(track.trackName)}</div>
                  <div class="result-sub">${escapeHtml(track.artistName)} ‚Äî ${escapeHtml(track.collectionName)}</div>
                </div>
                <div class="result-actions">
                  <button class="play">‚ñ∂ Preview</button>
                  <button class="playFull">‚ñ∂ Play Full</button>
                </div>
              </div>
            `;
          }).join('');

          // wire play buttons to player
          results.querySelectorAll('.result-item').forEach(el => {
            const btn = el.querySelector('.play');
            btn.addEventListener('click', ()=>{
              const track = {
                previewUrl: el.dataset.preview,
                artworkUrl100: el.dataset.artwork,
                trackName: el.dataset.track,
                artistName: el.dataset.artist,
                trackViewUrl: el.dataset.url
              };
              player.playTrack(track);
            });
            const playFullBtn = el.querySelector('.playFull');
            playFullBtn.addEventListener('click', async ()=>{
              // Play full track via Spotify Web API (requires user login & Premium)
              if (!window.spotifyToken) {
                window.open('http://localhost:8888/login', '_blank');
                return;
              }
              const q = `${el.dataset.track} ${el.dataset.artist}`;
              try {
                const searchUrl = `https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=1`;
                const searchRes = await fetch(searchUrl, { headers: { Authorization: 'Bearer ' + window.spotifyToken } });
                const searchData = await searchRes.json();
                if (searchData.tracks && searchData.tracks.items && searchData.tracks.items.length>0) {
                  const uri = searchData.tracks.items[0].uri;
                  if (!window.spotifyDeviceId) {
                    alert('Spotify player not ready. After login, allow the Web Playback SDK to initialize and select the Web Playback device in your Spotify client.');
                    return;
                  }
                  await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${window.spotifyDeviceId}`, {
                    method: 'PUT',
                    headers: { Authorization: 'Bearer ' + window.spotifyToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uris: [uri] })
                  });
                } else {
                  alert('No matching Spotify track found');
                }
              } catch (err) {
                console.error(err);
                alert('Error playing full track via Spotify API');
              }
            });
          });

        } catch (err) {
          results.innerHTML = '<div class="search-empty">Error searching</div>';
          console.error(err);
        }
      }

      function escapeHtml(s){
        return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : '';
      }
    })();
  </script>
  <script>
    // Spotify integration: read token from URL fragment, initialize Web Playback SDK
    (function(){
      const spotifyLoginBtn = document.getElementById('spotifyLoginBtn');
      const statusEl = document.getElementById('spotifyStatus');
      const hash = window.location.hash.substring(1);
      if (hash) {
        const params = new URLSearchParams(hash);
        const token = params.get('access_token');
        if (token) {
          window.spotifyToken = token;
          localStorage.setItem('spotify_token', token);
          statusEl.textContent = 'Logged in';
        }
      }
      if (!window.spotifyToken) window.spotifyToken = localStorage.getItem('spotify_token');
      if (window.spotifyToken) statusEl.textContent = 'Logged in';

      spotifyLoginBtn.addEventListener('click', ()=>{
        window.open('http://localhost:8888/login', '_blank');
      });

      // Load Web Playback SDK if we have a token
      if (window.spotifyToken) {
        const script = document.createElement('script');
        script.src = 'https://sdk.scdn.co/spotify-player.js';
        document.head.appendChild(script);
        window.onSpotifyWebPlaybackSDKReady = () => {
          const token = window.spotifyToken;
          const player = new Spotify.Player({
            name: 'My Web Playback SDK Player',
            getOAuthToken: cb => { cb(token); }
          });

          // Ready
          player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            window.spotifyDeviceId = device_id;
            statusEl.textContent = 'Player ready';
          });

          player.connect();
        };
      }
    })();
  </script>
